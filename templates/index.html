<!DOCTYPE html>
<html lang="ko">

<head>
    <!-- í•„ìš”í•œ ë©”íƒ€ íƒœê·¸ -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Stylish&display=swap" rel="stylesheet">

    <title>í¬ë˜í”„í†¤ ì •ê¸€ | ì •íœ˜ê±´</title>

    <!-- Custom CSS -->
    <style type="text/css">
        * {
            font-family: "Stylish", sans-serif;
        }

        .wrap {
            width: 900px;
            margin: auto;
        }

        .card-title {
            font-weight: bold;
        }

        .card-likes {
            margin-top: 10px;
        }

        .edit-delete-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .new-title,
        .new-text {
            display: none;
            width: 100%;
        }
    </style>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script>
        $(document).ready(function () {
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„ìš°ê³  ë©”ëª¨ë“¤ì„ ë³´ì—¬ì¤Œ
            $("#card-list").html("");
            showArticles();
        });

        // ë©”ëª¨ë¥¼ ì„œë²„ì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
        function postArticle() {
            let title = $("#memo-title").val();
            let content = $("#memo-content").val();

            $.ajax({
                type: "POST",
                url: "/memo",
                data: { title_give: title, content_give: content },
                success: function (response) {
                    if (response["result"] == "success") {
                        alert("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        showArticles(); // ì €ì¥ í›„ ë©”ëª¨ ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´
                    } else {
                        alert("ì„œë²„ ì˜¤ë¥˜!");
                    }
                }
            });
        }

        // ì„œë²„ì—ì„œ ë©”ëª¨ë“¤ì„ ê°€ì ¸ì™€ì„œ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function showArticles() {
            $.ajax({
                type: "GET",
                url: "/memo",
                success: function (response) {
                    let articles = response["articles"];
                    articles.sort((a, b) => b.likes - a.likes); // ì¢‹ì•„ìš” ìˆœìœ¼ë¡œ ì •ë ¬

                    $("#card-list").empty(); // ê¸°ì¡´ ë©”ëª¨ë“¤ì„ ì§€ì›€

                    articles.forEach(function (article) {
                        makeCard(article); // ê° ë©”ëª¨ë¥¼ ì¹´ë“œ í˜•íƒœë¡œ ë§Œë“¦
                    });
                },
                error: function () {
                    alert("ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        // ë©”ëª¨ë¥¼ ì¹´ë“œ í˜•íƒœë¡œ ë§Œë“œëŠ” í•¨ìˆ˜
        function makeCard(article) {
            let cardHtml = `<div class="card">
                        <div class="card-body">
                            <h5 class="card-title">${article.title}</h5>
                            <p class="card-text">${article.content}</p>
                            <p class="card-likes">${article.likes} </p>
                            <div class="edit-delete-buttons">
                                <button type="button" class="btn btn-info edit-button">ìˆ˜ì •</button>
                                <button type="button" class="btn btn-danger delete-button">ì‚­ì œ</button>
                                <button type="button" class="btn btn-primary link-like">ì¢‹ì•„ìš”!ğŸ‘</button>
                            </div>
                            <div>
                                <input class="form-control new-title" value="${article.title}">
                            </div>
                            <div>
                                <textarea class="form-control new-text">${article.content}</textarea>
                            </div>
                            <button type="button" class="btn btn-success save-button" style="display:none">ì €ì¥</button>
                        </div>
                    </div>`;

            $("#card-list").append(cardHtml);

            // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ
            $(".edit-button").last().click(function () {
                $(this).closest('.card-body').find('.card-title, .card-text, .edit-delete-buttons, .card-likes').hide();
                $(this).closest('.card-body').find('.new-title, .new-text, .save-button').show();
            });

            // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
            $(".save-button").click(function () {
                let articleId = article.time_id; // ë©”ëª¨ ID
                let newTitle = $(this).closest('.card-body').find('.new-title').val();
                let newText = $(this).closest('.card-body').find('.new-text').val();

                $.ajax({
                    type: "PUT",
                    url: "/memo/update",
                    data: { time_id: articleId, title: newTitle, content: newText },
                    success: function (response) {
                        if (response["result"] === "success") {
                            alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            showArticles(); // ìˆ˜ì • í›„ ë©”ëª¨ ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´
                        } else {
                            alert("ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    }
                });
            });

            // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
            $(".delete-button").last().click(function () {
                let articleId = article.time_id;

                $.ajax({
                    type: "DELETE",
                    url: "/memo",
                    data: { time_id: articleId },

                    success: function (response) {
                        if (response["result"] == "success") {
                            alert("ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            showArticles(); // ì‚­ì œ í›„ ë©”ëª¨ ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´
                        } else {
                            alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    }
                });
            });

            // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì‹œ
            $(".link-like").last().click(function () {
                let articleId = article.time_id;

                $.ajax({
                    type: "PUT",
                    url: "/memo/like",
                    data: { time_id: articleId },

                    success: function (response) {
                        if (response["result"] == "success") {
                            showArticles(); // ì¢‹ì•„ìš” í›„ ë©”ëª¨ ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´
                        } else {
                            alert("ì¢‹ì•„ìš” ì‹¤íŒ¨ã… ã… ");
                        }
                    }
                });
            });
        }
    </script>
</head>

<body>
    <div class="wrap">
        <div class="jumbotron">
            <h1 class="display-4" style="float: left">ë‚˜í™€ë¡œ ë©”ëª¨ì¥ <span class="badge badge-secondary">Ver2.0</span>
            </h1>

            <div id="post-box">
                <div>
                    <div class="form-group">
                        <input id="memo-title" class="form-control" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <textarea id="memo-content" class="form-control" rows="2" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" onclick="postArticle()">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
        <div id="card-list" class="card-columns"></div>
    </div>
</body>

</html>